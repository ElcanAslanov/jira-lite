generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = "postgresql://postgres:123456@localhost:5432/postgres"
}

enum GlobalRole {
  ADMIN
  USER
  REHBER
  ISCI
}

enum IssueType {
  TASK
  BUG
  STORY
}

enum IssueStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ProjectRole {
  ADMIN
  MEMBER
}

model User {
  id            String          @id @default(cuid())
  name          String?
  email         String          @unique
  phone         String?
  passwordHash  String
  role          GlobalRole      @default(USER)
  departmentId  String?
  department    Department?     @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  projects      Project[]       @relation("OwnerProjects")
  memberships   ProjectMember[]
  assignedTasks Issue[]         @relation("AssignedTasks")
  reportedTasks Issue[]         @relation("ReportedTasks")
  comments      IssueComment[]
  notifications Notification[]
  createdAt     DateTime        @default(now())
  lastLogin     DateTime?       @default(now())

  // üîπ √ñz-√∂z√ºn…ô …ôlaq…ô ‚Äî r…ôhb…ôr v…ô i≈ü√ßil…ôr √º√ß√ºn
  rehberId     String?
  rehber       User?   @relation("UserRehber", fields: [rehberId], references: [id], onDelete: SetNull)
  subordinates User[]  @relation("UserRehber")

  // üîπ RehberGroup …ôlaq…ôsi
  rehberGroups RehberGroup[] @relation("UserRehberGroups")
}

model Project {
  id          String          @id @default(cuid())
  name        String
  key         String          @unique
  description String?
  owner       User            @relation("OwnerProjects", fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId     String
  members     ProjectMember[]
  sprints     Sprint[]
  issues      Issue[]
  labels      Label[]
  createdAt   DateTime        @default(now())
}

model ProjectMember {
  id        String      @id @default(cuid())
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  role      ProjectRole @default(MEMBER)

  @@unique([projectId, userId])
}

model Sprint {
  id        String   @id @default(cuid())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  name      String
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(false)
  issues    Issue[]
}

model Issue {
  id          String         @id @default(cuid())
  title       String
  description String?
  priority    IssuePriority?
  status      IssueStatus    @default(TODO)
  type        IssueType      @default(TASK)
  projectId   String?
  sprintId    String?
  assigneeId  String?
  reporterId  String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  startDate   DateTime?
  endDate     DateTime?

  project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sprint  Sprint?  @relation(fields: [sprintId], references: [id], onDelete: Cascade)

  assignee User? @relation("AssignedTasks", fields: [assigneeId], references: [id], onDelete: SetNull)
  reporter User? @relation("ReportedTasks", fields: [reporterId], references: [id], onDelete: SetNull)

  comments      IssueComment[]
  labels        IssueLabel[]
  notifications Notification[]
  dueDate       DateTime?
  attachment    String?
}

model IssueComment {
  id        String   @id @default(cuid())
  issueId   String
  authorId  String
  body      String
  createdAt DateTime @default(now())

  issue  Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  author User  @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

model Label {
  id        String @id @default(cuid())
  projectId String
  name      String
  color     String

  project Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  issues  IssueLabel[]

  @@unique([projectId, name])
}

model IssueLabel {
  issueId String
  labelId String

  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  label Label @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@id([issueId, labelId])
}

model Notification {
  id        String   @id @default(cuid())
  message   String
  createdAt DateTime @default(now())
  isRead    Boolean  @default(false)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  issueId   String?
  issue     Issue?   @relation(fields: [issueId], references: [id], onDelete: Cascade)
}

model Company {
  id          String       @id @default(cuid())
  name        String
  logoUrl     String?
  departments Department[]
}

model Department {
  id           String        @id @default(cuid())
  name         String
  companyId    String
  company      Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  rehberGroups RehberGroup[]
  users        User[]
}

model RehberGroup {
  id           String     @id @default(cuid())
  name         String
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  users        User[]     @relation("UserRehberGroups")
}
